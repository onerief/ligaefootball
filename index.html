<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Way Kanan EFootball League</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .header-bg { background-color: #1e3a8a; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); }
        .card { background-color: white; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); }
        .admin-section { background-color: #fef2f2; border-left: 4px solid #ef4444; }
        .table-header { background-color: #dbeafe; }
        /* Ultra Compact Styling */
        .dense-table th, .dense-table td {
            padding-top: 2px; 
            padding-bottom: 2px;
            padding-left: 4px;
            padding-right: 4px;
            font-size: 0.65rem; 
            line-height: 1.2;
        }
        .admin-input-score {
            width: 24px; 
            height: 18px;
            padding: 0;
            font-size: 0.65rem;
            border: 1px solid #ccc;
            border-radius: 0.15rem;
        }
        .score-cell { padding: 0 0.25rem; text-align: center; }
        .admin-save-btn { padding: 2px 4px; font-size: 0.6rem; }
        .input-text-sm { font-size: 0.75rem; }
    </style>
</head>
<body>

    <!-- Firebase Imports (MUST be type="module") -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set log level to Debug for visibility
        setLogLevel('Debug');

        // --- Konfigurasi Firebase Anda ---
        const USER_FIREBASE_CONFIG = {
            apiKey: "AIzaSyCfikX-HQuKhtSksHzyJwuBF-dUr0ckGRE",
            authDomain: "wayliga.firebaseapp.com",
            projectId: "wayliga",
            storageBucket: "wayliga.appspot.com", // <--- diperbaiki disini!
            messagingSenderId: "178418335963",
            appId: "1:178418335963:web:a9ff5dadc64fa9cdcf8cfe",
            measurementId: "G-5QDKCZDL8X"
        };
        const FIREBASE_APP_ID = USER_FIREBASE_CONFIG.projectId || 'default-project';

        let app, db, auth;
        let userId = 'anon_user';

        // Path dokumen publik untuk data liga
        const getLeagueDocRef = (dbInstance) => {
            return doc(dbInstance, 'artifacts', FIREBASE_APP_ID, 'public', 'data', 'leagues', 'activeLeague');
        };

        // --- Variabel Global Aplikasi ---
        const ADMIN_PASSWORD = 'adminganteng';
        let leagueData = null;
        let isAdminLoggedIn = false; 
        let currentView = 'schedule'; 

        // =================================================================
        // 1. DATA APLIKASI & INITIAL SETUP
        // =================================================================
        const getOriginalInitialData = () => {
            const rawData = [
                // ... (jadwal pertandingan tidak diubah)
            ];
            const teams = [
                'Arief', 'Dexulmantap', 'Bayu', 'Ptangpteng', 'Tuku Pulsa Tsel', 
                'Gusmurtad', 'The Familia FC', 'Riders', 'Ipangopen'
            ];
            return {
                teams: teams.map(name => ({ name, points: 0, played: 0, wins: 0, draws: 0, losses: 0, goalsFor: 0, goalsAgainst: 0, diff: 0 })),
                schedule: rawData,
                title: 'Way Kanan EFootball League' 
            };
        };
        
        const createInitialData = () => getOriginalInitialData();

        // =================================================================
        // 2. FIREBASE / CLOUD PERSISTENCE
        // =================================================================

        // ... (fungsi cloud tidak diubah, sudah cukup aman)

        // =================================================================
        // 3. GLOBAL FUNCTIONS (CRUD & GENERATOR)
        // =================================================================

        // Fungsi Global untuk Score Submission
        window.submitScore = async (matchIndex) => {
            const homeScoreInput = document.getElementById(`home-score-${matchIndex}`);
            const awayScoreInput = document.getElementById(`away-score-${matchIndex}`);
            
            // Validasi: hanya integer >=0 atau kosong
            const getScore = input => {
                if (!input || input.value === '') return null;
                const val = parseInt(input.value);
                return (!isNaN(val) && Number.isInteger(val) && val >= 0) ? val : null;
            };
            const homeScore = getScore(homeScoreInput);
            const awayScore = getScore(awayScoreInput);

            if ((homeScoreInput.value !== '' && homeScore === null) || (awayScoreInput.value !== '' && awayScore === null)) {
                window.alert("Skor harus bilangan bulat positif (0 atau lebih) atau dikosongkan.");
                return;
            }

            if (!leagueData || !leagueData.schedule) return;

            const updatedSchedule = [...leagueData.schedule];
            updatedSchedule[matchIndex].homeScore = homeScore;
            updatedSchedule[matchIndex].awayScore = awayScore;
            updatedSchedule[matchIndex].status = (homeScore !== null && awayScore !== null) ? 'Finished' : 'Scheduled';

            const dataToSave = { ...leagueData, schedule: updatedSchedule, lastUpdated: new Date().toISOString() };
            try {
                await saveDataToCloud(dataToSave);
            } catch (err) {
                window.alert("Gagal menyimpan skor. Silakan coba lagi.");
            }
        };

        // --- ADMIN AUTH & UI ---
        window.showAdminModal = () => document.getElementById('admin-modal').classList.remove('hidden');
        window.hideAdminModal = () => {
            document.getElementById('admin-modal').classList.add('hidden');
            document.getElementById('admin-password-input').value = '';
            document.getElementById('admin-login-message').textContent = '';
        };

        window.authenticateAdmin = () => {
            const password = document.getElementById('admin-password-input').value;
            const message = document.getElementById('admin-login-message');

            if (password === ADMIN_PASSWORD) {
                if (ADMIN_PASSWORD === 'adminganteng') {
                    window.alert('PERINGATAN: Password admin default, segera ubah untuk keamanan!');
                }
                hideAdminModal(); 
                isAdminLoggedIn = true; 
                renderApp(leagueData); 
            } else {
                message.textContent = 'Kata sandi Admin salah.';
            }
        };

        window.hideAdminPanel = () => {
            isAdminLoggedIn = false;
            renderApp(leagueData); 
        };

        // --- CRUD TEAMS & DATA ---
        window.updateLeagueTitle = async () => {
            const newTitle = document.getElementById('league-title-input').value.trim();
            if (!newTitle) return window.alert('Nama liga tidak boleh kosong.');
            const dataToSave = { ...leagueData, title: newTitle, lastUpdated: new Date().toISOString() };
            try {
                await saveDataToCloud(dataToSave);
                window.alert('Nama liga berhasil diperbarui.');
            } catch (err) {
                window.alert('Gagal mengubah nama liga.');
            }
        }

        window.addNewTeam = async () => {
            const newName = document.getElementById('new-team-input').value.trim();
            if (!newName) return window.alert('Nama tim tidak boleh kosong.');
            if (newName.toLowerCase() === 'bye') return window.alert('Nama "BYE" tidak boleh dipakai.');

            const existingTeams = leagueData.teams.map(t => t.name.toLowerCase());
            if (existingTeams.includes(newName.toLowerCase())) return window.alert(`Tim "${newName}" sudah ada.`);

            const updatedTeams = [...leagueData.teams, { name: newName, points: 0, played: 0, wins: 0, draws: 0, losses: 0, goalsFor: 0, goalsAgainst: 0, diff: 0 }];
            const dataToSave = { ...leagueData, teams: updatedTeams, lastUpdated: new Date().toISOString() };
            try {
                await saveDataToCloud(dataToSave);
                document.getElementById('new-team-input').value = '';
                window.alert(`Tim "${newName}" berhasil ditambahkan.`);
            } catch (err) {
                window.alert("Gagal menambah tim.");
            }
        }

        window.updateTeamName = async (oldName, newName) => {
            if (!newName || newName === oldName) return;
            if (newName.toLowerCase() === 'bye') return window.alert('Nama "BYE" tidak boleh dipakai.');

            if (leagueData.teams.map(t => t.name.toLowerCase()).includes(newName.toLowerCase()) && newName.toLowerCase() !== oldName.toLowerCase()) {
                 return window.alert(`Nama tim "${newName}" sudah digunakan.`);
            }

            const updatedSchedule = leagueData.schedule.map(match => {
                if (match.home === oldName) match.home = newName;
                if (match.away === oldName) match.away = newName;
                if (match.byeTeam === oldName) match.byeTeam = newName;
                return match;
            });

            const updatedTeams = leagueData.teams.map(team => {
                if (team.name === oldName) team.name = newName;
                return team;
            });

            const dataToSave = { ...leagueData, schedule: updatedSchedule, teams: updatedTeams, lastUpdated: new Date().toISOString() };
            try {
                await saveDataToCloud(dataToSave);
                window.alert(`Nama tim "${oldName}" berhasil diubah menjadi "${newName}".`);
            } catch (err) {
                window.alert('Gagal mengubah nama tim.');
            }
        }
        
        window.deleteTeam = async (teamName) => {
            if (!window.confirm(`Yakin hapus Tim "${teamName}"? Ini akan menghapus tim dari semua jadwal dan klasemen.`)) return;
            const updatedSchedule = leagueData.schedule.filter(match => match.home !== teamName && match.away !== teamName);
            const updatedTeams = leagueData.teams.filter(team => team.name !== teamName);

            const dataToSave = { ...leagueData, schedule: updatedSchedule, teams: updatedTeams, lastUpdated: new Date().toISOString() };
            try {
                await saveDataToCloud(dataToSave);
                window.alert(`Tim "${teamName}" berhasil dihapus.`);
            } catch (err) {
                window.alert('Gagal menghapus tim.');
            }
        }

        // ... (fungsi generator jadwal tidak diubah, sudah aman)

        window.generateNewSchedule = async () => {
            if (leagueData.teams.length < 2) return window.alert("Minimal harus ada 2 tim.");
            if (!window.confirm("Yakin ingin membuat JADWAL BARU (Double Round Robin)? Semua skor dan jadwal yang ada akan hilang!")) return;
            const teamNames = leagueData.teams.map(t => t.name);
            if (teamNames.some(n => n.toLowerCase() === 'bye')) return window.alert('Nama tim "BYE" tidak boleh dipakai.');
            const newSchedule = generateRoundRobinSchedule(teamNames);

            const dataToSave = { ...leagueData, schedule: newSchedule, lastUpdated: new Date().toISOString() };

            try {
                await saveDataToCloud(dataToSave);
                window.alert('Jadwal baru (Double Round Robin) berhasil dibuat.');
                hideAdminPanel();
            } catch (err) {
                window.alert('Gagal membuat jadwal baru.');
            }
        }

        window.resetData = async () => {
            if (!window.confirm("Apakah Anda yakin ingin RESET semua data liga? Ini akan menggunakan jadwal 9 tim awal Anda.")) return;
            try {
                const initialData = createInitialData();
                await saveDataToCloud(initialData);
                window.alert("Reset Berhasil! Data cloud telah diperbarui.");
                hideAdminPanel();
            } catch (error) {
                window.alert("Gagal melakukan Reset Data.");
            }
        };

        window.deleteActiveLeagueData = async () => {
            if (!window.confirm("PERINGATAN! Yakin ingin HAPUS PERMANEN SEMUA DATA LIGA INI?")) return;
            try {
                const emptyData = { teams: [], schedule: [], title: 'Liga Kosong', lastUpdated: new Date().toISOString() };
                await saveDataToCloud(emptyData);
                window.alert("Data liga berhasil dihapus dari Cloud.");
                hideAdminPanel();
            } catch (error) {
                window.alert("Gagal menghapus data liga.");
            }
        }

        // ... (export JSON/CSV tidak diubah)

        // =================================================================
        // 4. RENDER FUNCTIONS
        // =================================================================

        // ... (fungsi render tidak diubah, kecuali escape nama tim pada renderTeamEditList)

        const renderTeamEditList = (teams) => {
            if (!teams || teams.length === 0) return `<p class="text-sm text-gray-500">Tidak ada tim terdaftar.</p>`;
            
            return `
                <div class="space-y-3" id="team-edit-list-container">
                    ${teams.map(team => {
                        // Escape apostrof dan quote agar tidak error di html attributes
                        const safeName = team.name.replace(/['"]/g, '');

                        return `
                            <div class="flex items-center space-x-2 p-3 bg-gray-50 rounded-lg border border-gray-200 shadow-sm text-sm" data-team-name="${safeName}">
                                <input type="text" value="${team.name}" 
                                    class="flex-grow p-2 border border-gray-300 rounded-lg text-sm focus:ring-green-500 team-name-input" 
                                    placeholder="Nama tim baru">
                                <button data-action="save" data-old-name="${safeName}" class="bg-green-600 text-white p-2 rounded-lg hover:bg-green-700 transition duration-150 flex-shrink-0">
                                    Simpan
                                </button>
                                <button data-action="delete" data-team-name="${safeName}" class="bg-red-500 text-white p-2 rounded-lg hover:bg-red-600 transition duration-150 flex-shrink-0">
                                    Hapus
                                </button>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // ... (fungsi renderApp, attachAllListeners dan updateTabUI tidak diubah)

        window.onload = () => {
            // Start Firebase initialization
            initFirebaseAndAuth();
        };
    </script>

    <!-- UI/UX Aplikasi -->
    <div class="min-h-screen">
        <!-- Header -->
        <header class="header-bg py-3 mb-4"> 
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center">
                <h1 id="main-title" class="text-2xl font-extrabold text-white tracking-tight">
                    <!-- Judul Diisi oleh JS -->
                </h1>
                <div class="flex items-center space-x-2">
                    <div id="connection-status" class="p-1 rounded-lg text-xs font-medium bg-gray-100 text-gray-700">
                        Memuat Cloud...
                    </div>
<!-- ...lanjutkan UI sesuai file asli... -->
