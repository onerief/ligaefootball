<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liga EFootball</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        .header-bg {
            background-color: #1e3a8a; /* Dark blue for header */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }
        .btn-primary {
            background-color: #3b82f6;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .admin-section {
            background-color: #fee2e2;
            border-left: 4px solid #ef4444;
        }
        .table-header {
            background-color: #eff6ff;
        }
    </style>
</head>
<body>

    <!-- Firebase Imports (MUST be type="module") -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Atur log level ke Debug untuk melihat koneksi Firestore
        setLogLevel('Debug');

        // --- Variabel Global Canvas Mandatori ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = 'anon_user';
        const ADMIN_PASSWORD = 'adminganteng';
        let leagueData = null;
        let isAdminLoggedIn = false; 
        let currentView = 'schedule'; // NEW: State untuk melacak tab aktif

        // Path dokumen publik untuk data liga
        const getLeagueDocRef = (dbInstance) => {
            return doc(dbInstance, 'artifacts', appId, 'public', 'data', 'leagues', 'activeLeague');
        };

        // --- DATA JADWAL ASLI PENGGUNA (9 TIM) ---
        const getOriginalInitialData = () => {
            const rawData = [
                // Babak 1
                { home: 'Arief', away: 'Dexulmantap', homeScore: 3, awayScore: 2, status: 'Finished', babak: 1, match: 1 },
                { home: 'Bayu', away: 'Ptangpteng', homeScore: 2, awayScore: 3, status: 'Finished', babak: 1, match: 2 },
                { home: 'Tuku Pulsa Tsel', away: 'Gusmurtad', homeScore: 3, awayScore: 4, status: 'Finished', babak: 1, match: 3 },
                { home: 'The Familia FC', away: 'Riders', homeScore: 0, awayScore: 3, status: 'Finished', babak: 1, match: 4 },
                // Babak 2
                { home: 'Ipangopen', away: 'Riders', homeScore: 8, awayScore: 2, status: 'Finished', babak: 2, match: 5 },
                { home: 'Arief', away: 'Gusmurtad', homeScore: 3, awayScore: 3, status: 'Finished', babak: 2, match: 6 },
                { home: 'Ptangpteng', away: 'Tuku Pulsa Tsel', homeScore: 2, awayScore: 1, status: 'Finished', babak: 2, match: 7 },
                { home: 'Dexulmantap', away: 'The Familia FC', homeScore: 3, awayScore: 6, status: 'Finished', babak: 2, match: 8 },
                // Babak 3 (dst - skor null)
                { home: 'Ipangopen', away: 'Arief', homeScore: null, awayScore: null, status: 'Scheduled', babak: 3, match: 9 },
                { home: 'Bayu', away: 'Gusmurtad', homeScore: null, awayScore: null, status: 'Scheduled', babak: 3, match: 10 },
                { home: 'Ptangpteng', away: 'Riders', homeScore: null, awayScore: null, status: 'Scheduled', babak: 3, match: 11 },
                { home: 'Tuku Pulsa Tsel', away: 'The Familia FC', homeScore: null, awayScore: null, status: 'Scheduled', babak: 3, match: 12 },
                // Babak 4
                { home: 'Ipangopen', away: 'Bayu', homeScore: null, awayScore: null, status: 'Scheduled', babak: 4, match: 13 },
                { home: 'Arief', away: 'Ptangpteng', homeScore: null, awayScore: null, status: 'Scheduled', babak: 4, match: 14 },
                { home: 'Gusmurtad', away: 'The Familia FC', homeScore: null, awayScore: null, status: 'Scheduled', babak: 4, match: 15 },
                { home: 'Dexulmantap', away: 'Riders', homeScore: null, awayScore: null, status: 'Scheduled', babak: 4, match: 16 },
                // Babak 5
                { home: 'Ipangopen', away: 'Ptangpteng', homeScore: null, awayScore: null, status: 'Scheduled', babak: 5, match: 17 },
                { home: 'Bayu', away: 'The Familia FC', homeScore: null, awayScore: null, status: 'Scheduled', babak: 5, match: 18 },
                { home: 'Arief', away: 'Tuku Pulsa Tsel', homeScore: null, awayScore: null, status: 'Scheduled', babak: 5, match: 19 },
                { home: 'Gusmurtad', away: 'Dexulmantap', homeScore: null, awayScore: null, status: 'Scheduled', babak: 5, match: 20 },
                // Babak 6
                { home: 'Ipangopen', away: 'Tuku Pulsa Tsel', homeScore: null, awayScore: null, status: 'Scheduled', babak: 6, match: 21 },
                { home: 'Bayu', away: 'Dexulmantap', homeScore: null, awayScore: null, status: 'Scheduled', babak: 6, match: 22 },
                { home: 'Ptangpteng', away: 'Gusmurtad', homeScore: null, awayScore: null, status: 'Scheduled', babak: 6, match: 23 },
                { home: 'Riders', away: 'Arief', homeScore: null, awayScore: null, status: 'Scheduled', babak: 6, match: 24 },
                // Babak 7
                { home: 'Ipangopen', away: 'Gusmurtad', homeScore: null, awayScore: null, status: 'Scheduled', babak: 7, match: 25 },
                { home: 'Bayu', away: 'Tuku Pulsa Tsel', homeScore: null, awayScore: null, status: 'Scheduled', babak: 7, match: 26 },
                { home: 'Ptangpteng', away: 'The Familia FC', homeScore: null, awayScore: null, status: 'Scheduled', babak: 7, match: 27 },
                { home: 'Riders', away: 'Dexulmantap', homeScore: null, awayScore: null, status: 'Scheduled', babak: 7, match: 28 },
                // Babak 8
                { home: 'Ipangopen', away: 'The Familia FC', homeScore: null, awayScore: null, status: 'Scheduled', babak: 8, match: 29 },
                { home: 'Bayu', away: 'Arief', homeScore: null, awayScore: null, status: 'Scheduled', babak: 8, match: 30 },
                { home: 'Ptangpteng', away: 'Dexulmantap', homeScore: null, awayScore: null, status: 'Scheduled', babak: 8, match: 31 },
                { home: 'Tuku Pulsa Tsel', away: 'Riders', homeScore: null, awayScore: null, status: 'Scheduled', babak: 8, match: 32 },
                // Babak 9
                { home: 'Ipangopen', away: 'Dexulmantap', homeScore: null, awayScore: null, status: 'Scheduled', babak: 9, match: 33 },
                { home: 'Bayu', away: 'Riders', homeScore: null, awayScore: null, status: 'Scheduled', babak: 9, match: 34 },
                { home: 'Ptangpteng', away: 'Arief', homeScore: null, awayScore: null, status: 'Scheduled', babak: 9, match: 35 },
                { home: 'Tuku Pulsa Tsel', away: 'Gusmurtad', homeScore: null, awayScore: null, status: 'Scheduled', babak: 9, match: 36 }
            ];

            const teams = [
                'Arief', 'Dexulmantap', 'Bayu', 'Ptangpteng', 'Tuku Pulsa Tsel', 
                'Gusmurtad', 'The Familia FC', 'Riders', 'Ipangopen'
            ];

            return {
                teams: teams.map(name => ({ 
                    name, 
                    points: 0, played: 0, wins: 0, draws: 0, losses: 0, goalsFor: 0, goalsAgainst: 0, diff: 0 
                })),
                schedule: rawData,
                lastUpdated: new Date().toISOString()
            };
        };
        
        // Fungsi untuk membersihkan dan membuat struktur data awal
        const createInitialData = () => {
            return getOriginalInitialData();
        };
        // --- END DATA JADWAL ASLI PENGGUNA ---


        // Fungsi Penulisan Data ke Cloud (KRUSIAL UNTUK KONEKSI)
        const saveDataToCloud = async (dataToSave) => {
            if (!db) {
                console.error("Firestore tidak terinisialisasi.");
                return;
            }
            try {
                // Gunakan setDoc dengan merge: false untuk menimpa/membuat dokumen baru
                // Ini memastikan dokumen awal dibuat jika belum ada.
                await setDoc(getLeagueDocRef(db), dataToSave, { merge: false });
                console.log("Data liga berhasil disimpan ke Cloud Firestore.");
                updateConnectionStatus(true, "Cloud Database terhubung dan sinkron.");
            } catch (error) {
                console.error("Gagal menyimpan data ke Firestore:", error);
                updateConnectionStatus(false, "Kesalahan koneksi Cloud Database: " + error.message);
            }
        };

        // Fungsi Admin untuk Reset Data (Memaksa Penulisan Awal)
        window.resetData = async () => {
            if (!auth.currentUser) {
                alert('Otentikasi gagal. Coba muat ulang aplikasi.');
                return;
            }
            // Menggunakan fungsi window.confirm sebagai pengganti alert.
            if (!window.confirm("Apakah Anda yakin ingin RESET semua data liga? Ini akan menggunakan jadwal 9 tim awal Anda.")) {
                return;
            }

            try {
                const initialData = createInitialData();
                await saveDataToCloud(initialData);
                // alert("Data liga berhasil direset dan disimpan ke Cloud."); // Dihapus karena updateConnectionStatus sudah menangani notifikasi sukses.
                hideAdminPanel(); // Sembunyikan panel setelah sukses
            } catch (error) {
                console.error("Gagal melakukan reset data:", error);
                // Menggunakan window.alert sebagai pengganti alert.
                window.alert("Gagal melakukan reset data: " + error.message);
            }
        };

        // Fungsi untuk menginisialisasi Firebase dan Otentikasi
        const initFirebaseAndAuth = async () => {
            // Konfigurasi Firebase Anda:
            const USER_FIREBASE_CONFIG = {
                apiKey: "AIzaSyCfikX-HQuKhtSksHzyJwuBF-dUr0ckGRE", 
                authDomain: "wayliga.firebaseapp.com", 
                projectId: "wayliga", 
                storageBucket: "wayliga.firebasestorage.app", 
                messagingSenderId: "178418335963", 
                appId: "1:178418335963:web:a9ff5dadc64fa9cdcf8cfe", 
                measurementId: "G-5QDKCZDL8X" 
            };

            // Prioritaskan konfigurasi Canvas, fallback ke konfigurasi Pengguna
            const currentFirebaseConfig = firebaseConfig || USER_FIREBASE_CONFIG;

            if (!currentFirebaseConfig) {
                document.getElementById('app-container').innerHTML = `
                    <div class="card p-8 bg-red-100 text-red-800">
                        <p class="font-bold">Kesalahan Konfigurasi:</p>
                        <p>Kunci Firebase tidak ditemukan. Tidak dapat menghubungkan ke Cloud.</p>
                    </div>
                `;
                return;
            }

            try {
                app = initializeApp(currentFirebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Otentikasi Pengguna
                await new Promise((resolve) => {
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            console.log(`Otentikasi berhasil. User ID: ${userId}`);
                        } else {
                            // Coba otentikasi dengan token kustom (jika tersedia) atau anonim
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        }
                        unsubscribe(); // Hentikan listener setelah otentikasi awal
                        resolve();
                    });
                });
                
                // Mulai Mendengarkan Data Setelah Auth Selesai
                listenToLeagueData();
                
            } catch (error) {
                console.error("Kesalahan saat inisialisasi Firebase atau Otentikasi:", error);
                updateConnectionStatus(false, "Gagal memulai aplikasi: " + error.message);
            }
        };
        
        // Fungsi Listener Real-time
        const listenToLeagueData = () => {
             // Pastikan auth.currentUser memiliki UID sebelum mendengarkan data publik
            if (!auth.currentUser || !auth.currentUser.uid) {
                console.error("User belum terotentikasi. Tidak dapat memulai listener.");
                updateConnectionStatus(false, "Menunggu otentikasi...");
                return;
            }
            
            const docRef = getLeagueDocRef(db);
            
            // Memulai listener real-time
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    // Data ditemukan dan dimuat
                    leagueData = docSnap.data();
                    console.log("Data diterima dari Cloud.");
                    renderApp(leagueData);
                    updateConnectionStatus(true, "Cloud Database terhubung dan sinkron.");
                } else {
                    // Dokumen belum ada. 
                    console.log("Dokumen liga belum ada. Memuat data default.");
                    updateConnectionStatus(false, "Dokumen Database belum ada. Admin perlu Reset Data.");
                    leagueData = createInitialData();
                    renderApp(leagueData); // Tampilkan data default
                }
            }, (error) => {
                // Tangani kegagalan koneksi atau otentikasi rules
                console.error("Kesalahan listener Firestore:", error);
                updateConnectionStatus(false, "Kesalahan koneksi Cloud Database: " + error.message);
            });
        };
        
        // --- Fungsi Logika Aplikasi ---

        const calculateStandings = (data) => {
            const standingsMap = new Map(data.teams.map(team => [team.name, { ...team, points: 0, played: 0, wins: 0, draws: 0, losses: 0, goalsFor: 0, goalsAgainst: 0, diff: 0 }]));

            data.schedule.forEach(match => {
                if (match.homeScore !== null && match.awayScore !== null) {
                    const homeTeam = standingsMap.get(match.home);
                    const awayTeam = standingsMap.get(match.away);

                    if (!homeTeam || !awayTeam) return;

                    homeTeam.played++;
                    awayTeam.played++;
                    homeTeam.goalsFor += match.homeScore;
                    homeTeam.goalsAgainst += match.awayScore;
                    awayTeam.goalsFor += match.awayScore;
                    awayTeam.goalsAgainst += match.homeScore;
                    homeTeam.diff = homeTeam.goalsFor - homeTeam.goalsAgainst;
                    awayTeam.diff = awayTeam.goalsFor - awayTeam.goalsAgainst;

                    if (match.homeScore > match.awayScore) {
                        homeTeam.points += 3;
                        homeTeam.wins++;
                        awayTeam.losses++;
                    } else if (match.homeScore < match.awayScore) {
                        awayTeam.points += 3;
                        awayTeam.wins++;
                        homeTeam.losses++;
                    } else {
                        homeTeam.points += 1;
                        awayTeam.points += 1;
                        homeTeam.draws++;
                        awayTeam.draws++;
                    }
                }
            });

            const finalStandings = Array.from(standingsMap.values()).sort((a, b) => {
                if (b.points !== a.points) return b.points - a.points;
                if (b.diff !== a.diff) return b.diff - a.diff;
                return b.goalsFor - a.goalsFor;
            });

            return finalStandings;
        };

        window.submitScore = async (matchIndex) => {
            const homeScoreInput = document.getElementById(`home-score-${matchIndex}`);
            const awayScoreInput = document.getElementById(`away-score-${matchIndex}`);
            
            // Menggunakan nilai null jika input kosong
            const homeScore = homeScoreInput.value === '' ? null : parseInt(homeScoreInput.value);
            const awayScore = awayScoreInput.value === '' ? null : parseInt(awayScoreInput.value);

            // Validasi: hanya terima nilai null atau angka positif/nol
            if ((homeScore !== null && (isNaN(homeScore) || homeScore < 0)) || (awayScore !== null && (isNaN(awayScore) || awayScore < 0))) {
                window.alert("Skor harus angka positif atau dikosongkan.");
                return;
            }

            if (!leagueData || !leagueData.schedule) {
                window.alert("Data liga belum dimuat. Coba muat ulang.");
                return;
            }

            const updatedSchedule = [...leagueData.schedule];
            updatedSchedule[matchIndex].homeScore = homeScore;
            updatedSchedule[matchIndex].awayScore = awayScore;
            updatedSchedule[matchIndex].status = (homeScore !== null && awayScore !== null) ? 'Finished' : 'Scheduled';

            const dataToSave = { 
                ...leagueData, 
                schedule: updatedSchedule,
                lastUpdated: new Date().toISOString()
            };

            await saveDataToCloud(dataToSave);
        };
        
        // --- Fungsi Render UI ---

        const updateConnectionStatus = (isSuccess, message) => {
            const statusEl = document.getElementById('connection-status');
            statusEl.textContent = message;
            statusEl.className = `p-2 rounded-lg text-sm font-medium transition-colors duration-300 ${isSuccess ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
        };

        const renderStandings = (standings) => {
            return `
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Klasemen Liga</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr class="table-header text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                <th class="py-3 px-4 rounded-tl-lg">#</th>
                                <th class="py-3 px-4">Klub</th>
                                <th class="py-3 px-4">Main</th>
                                <th class="py-3 px-4">M</th>
                                <th class="py-3 px-4">S</th>
                                <th class="py-3 px-4">K</th>
                                <th class="py-3 px-4">GM</th>
                                <th class="py-3 px-4">GK</th>
                                <th class="py-3 px-4">SG</th>
                                <th class="py-3 px-4 rounded-tr-lg">Poin</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${standings.map((team, index) => `
                                <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-blue-50 transition-colors">
                                    <td class="py-3 px-4 font-medium">${index + 1}</td>
                                    <td class="py-3 px-4 font-semibold text-gray-900">${team.name}</td>
                                    <td class="py-3 px-4">${team.played}</td>
                                    <td class="py-3 px-4">${team.wins}</td>
                                    <td class="py-3 px-4">${team.draws}</td>
                                    <td class="py-3 px-4">${team.losses}</td>
                                    <td class="py-3 px-4">${team.goalsFor}</td>
                                    <td class="py-3 px-4">${team.goalsAgainst}</td>
                                    <td class="py-3 px-4 font-bold ${team.diff > 0 ? 'text-green-600' : team.diff < 0 ? 'text-red-600' : 'text-gray-500'}">${team.diff}</td>
                                    <td class="py-3 px-4 text-lg font-extrabold text-blue-600">${team.points}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        };

        const renderMatchSchedule = (schedule) => {
            // Group matches by babak for display
            const groupedSchedule = schedule.reduce((acc, match) => {
                const babak = match.babak || 'Unknown';
                if (!acc[babak]) acc[babak] = [];
                acc[babak].push(match);
                return acc;
            }, {});

            const babakKeys = Object.keys(groupedSchedule).sort((a, b) => parseInt(a) - parseInt(b));

            return `
                <h2 class="text-2xl font-bold text-gray-800 mb-4 mt-8">Jadwal Pertandingan</h2>
                <div class="space-y-8">
                    ${babakKeys.map(babak => `
                        <div class="border-b pb-4">
                            <h3 class="text-xl font-bold text-gray-700 mb-3 border-l-4 border-blue-500 pl-2">Babak ${babak}</h3>
                            <div class="space-y-4">
                                ${groupedSchedule[babak].map((match, index) => {
                                    // Calculate global index to save to the main schedule array
                                    const globalIndex = leagueData.schedule.findIndex(m => m.home === match.home && m.away === match.away && m.babak === match.babak);
                                    
                                    const isFinished = match.status === 'Finished';
                                    const homeScoreDisplay = match.homeScore !== null ? match.homeScore : '';
                                    const awayScoreDisplay = match.awayScore !== null ? match.awayScore : '';
                                    
                                    // FIX: Define statusClass here before usage
                                    let statusClass = 'text-sm font-medium ';
                                    if (isFinished) {
                                        statusClass += 'text-blue-500'; 
                                    } else {
                                        statusClass += 'text-gray-500';
                                    }

                                    // LOGIC FOR WINNER/LOSER COLORING
                                    let homeNameClass = 'text-gray-900';
                                    let awayNameClass = 'text-gray-900';

                                    if (isFinished) {
                                        if (match.homeScore > match.awayScore) {
                                            homeNameClass = 'text-green-600 font-extrabold'; // Winner
                                            awayNameClass = 'text-red-500 font-medium';      // Loser
                                        } else if (match.homeScore < match.awayScore) {
                                            homeNameClass = 'text-red-500 font-medium';      // Loser
                                            awayNameClass = 'text-green-600 font-extrabold'; // Winner
                                        } else {
                                            homeNameClass = 'text-blue-600 font-semibold';   // Draw
                                            awayNameClass = 'text-blue-600 font-semibold';   // Draw
                                        }
                                    }

                                    const scoreInputs = `
                                        <div class="flex items-center justify-center space-x-3">
                                            <input id="home-score-${globalIndex}" type="number" min="0" value="${homeScoreDisplay}" placeholder="0" 
                                                class="w-16 p-1.5 border border-gray-300 rounded-lg text-center font-bold text-lg focus:ring-blue-500 focus:border-blue-500">
                                            <span class="text-2xl font-bold mx-1">-</span>
                                            <input id="away-score-${globalIndex}" type="number" min="0" value="${awayScoreDisplay}" placeholder="0" 
                                                class="w-16 p-1.5 border border-gray-300 rounded-lg text-center font-bold text-lg focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                    `;
                                    
                                    const saveButton = `
                                        <button onclick="submitScore(${globalIndex})" 
                                            class="btn-primary w-full sm:w-auto text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 mt-2 sm:mt-0">
                                            Simpan
                                        </button>
                                    `;
                                    
                                    // NEW: Score display with color distinction
                                    const scoreDisplay = isFinished ? 
                                        `<p class="text-3xl font-extrabold">
                                            <span class="${homeNameClass}">${match.homeScore}</span> 
                                            <span class="mx-2 text-gray-500 font-normal">-</span> 
                                            <span class="${awayNameClass}">${match.awayScore}</span>
                                        </p>` 
                                        : `<p class="text-xl font-normal text-gray-500">Belum Main</p>`;


                                    return `
                                        <div class="card flex flex-col items-start p-4 shadow-md transition-shadow duration-300 hover:shadow-lg">
                                            <div class="w-full flex justify-between items-center mb-2">
                                                <span class="${statusClass}">${match.status === 'Finished' ? `Selesai` : `Terjadwal`} - Match ${match.match || 'N/A'}</span>
                                            </div>

                                            <!-- Tim 1 vs Tim 2 with color coding -->
                                            <div class="w-full flex justify-between items-center text-center py-2 border-b border-gray-100">
                                                <p class="text-xl ${homeNameClass} font-extrabold w-1/3 text-left truncate">${match.home}</p>
                                                <span class="text-lg font-normal text-gray-500 w-1/3">vs</span>
                                                <p class="text-xl ${awayNameClass} font-extrabold w-1/3 text-right truncate">${match.away}</p>
                                            </div>

                                            <!-- Bagian Skor/Input (Tergantung status login) -->
                                            <div class="w-full flex flex-col items-center mt-3 pt-3">
                                                ${isAdminLoggedIn ? 
                                                    `<div class="w-full flex flex-col items-center space-y-3">
                                                        <div class="flex justify-center w-full space-x-2">${scoreInputs}</div>
                                                        ${saveButton}
                                                    </div>`
                                                    : scoreDisplay
                                                }
                                            </div>
                                            
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        };
        
        // New function to update the tab bar appearance
        const updateTabUI = (activeTabName) => {
            const tabs = ['schedule', 'standings'];
            tabs.forEach(name => {
                const tabEl = document.getElementById(`tab-${name}`);
                if (tabEl) {
                    if (name === activeTabName) {
                        tabEl.classList.add('border-blue-600', 'bg-gray-50');
                        tabEl.classList.remove('border-transparent', 'bg-white');
                    } else {
                        tabEl.classList.remove('border-blue-600', 'bg-gray-50');
                        tabEl.classList.add('border-transparent', 'bg-white');
                    }
                }
            });
        };

        window.setActiveTab = (tabName) => {
            currentView = tabName;
            if (leagueData) {
                renderApp(leagueData);
            }
            updateTabUI(currentView);
        };
        
        const renderAdminPanel = () => {
            const lastUpdated = leagueData?.lastUpdated ? new Date(leagueData.lastUpdated).toLocaleString('id-ID') : 'Belum pernah diupdate';
            return `
                <div id="admin-panel" class="card admin-section mt-10 p-6">
                    <h2 class="text-2xl font-bold text-red-700 mb-4">Panel Admin (Hanya untuk Pengembang)</h2>
                    <p class="mb-4 text-sm text-red-600">Terakhir Diperbarui: ${lastUpdated}</p>
                    
                    <div class="space-y-4">
                        <h3 class="font-semibold text-lg text-red-700">1. Status Koneksi & Otentikasi</h3>
                        <div class="bg-red-50 p-3 rounded-lg text-sm">
                            <p><strong>App ID:</strong> <code>${appId}</code></p>
                            <p><strong>User ID (Auth):</strong> <code>${auth.currentUser?.uid || 'LOADING'}</code></p>
                        </div>
                        
                        <h3 class="font-semibold text-lg text-red-700">2. Data Tim Aktif</h3>
                        <pre class="bg-red-50 p-3 rounded-lg text-xs overflow-x-auto">${JSON.stringify(leagueData?.teams.map(t => t.name) || [], null, 2)}</pre>

                        <h3 class="font-semibold text-lg text-red-700">3. Reset Data Pertandingan (Solusi Koneksi)</h3>
                        <p class="text-red-800">Tindakan ini akan menghapus semua data skor dan klasemen, lalu menulis ulang struktur data awal **(Jadwal 9 Tim)** ke Cloud Firestore. **Ini adalah langkah paling efektif untuk memaksa koneksi database awal.**</p>
                        <button onclick="resetData()" 
                                class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                            Reset Jadwal & Skor di Liga Aktif ke Awal
                        </button>
                    </div>
                    <button onclick="hideAdminPanel()" class="mt-6 text-sm text-red-500 hover:text-red-700">Tutup Panel Admin</button>
                </div>
            `;
        };

        // --- FUNGSI MODAL BARU ---
        
        window.showAdminModal = () => {
            document.getElementById('admin-modal').classList.remove('hidden');
            document.getElementById('admin-password-input').focus();
        };

        window.hideAdminModal = () => {
            document.getElementById('admin-modal').classList.add('hidden');
            document.getElementById('admin-password-input').value = '';
            document.getElementById('admin-login-message').textContent = '';
        };

        window.authenticateAdmin = () => {
            const passwordInput = document.getElementById('admin-password-input');
            const password = passwordInput.value;
            const message = document.getElementById('admin-login-message');

            if (password === ADMIN_PASSWORD) {
                hideAdminModal(); // Sembunyikan modal
                
                // FIX: Gunakan flag global dan panggil renderApp untuk rendering panel
                isAdminLoggedIn = true; 
                renderApp(leagueData); 
            } else {
                message.textContent = 'Kata sandi Admin salah.';
                passwordInput.value = '';
            }
        };

        window.hideAdminPanel = () => {
            // FIX: Gunakan flag global dan panggil renderApp untuk logout
            isAdminLoggedIn = false;
            renderApp(leagueData); // Re-render untuk menonaktifkan input skor
        };


        const renderApp = (data) => {
            const appContainer = document.getElementById('app-container');
            
            let contentHtml = '';
            if (currentView === 'schedule') {
                // Tampilkan Jadwal
                contentHtml = renderMatchSchedule(data.schedule);
            } else if (currentView === 'standings') {
                // Tampilkan Klasemen
                const standings = calculateStandings(data);
                contentHtml = renderStandings(standings);
            }
            
            // Render konten utama
            appContainer.innerHTML = `
                <div class="card p-6 w-full mb-8">
                    ${contentHtml}
                </div>
                <!-- Render panel admin jika flag true -->
                ${isAdminLoggedIn ? renderAdminPanel() : ''}
            `;

            // Atur status disabled pada input skor berdasarkan status login
            const scheduleContainer = document.querySelector('.space-y-8');
            if (scheduleContainer) {
                scheduleContainer.querySelectorAll('input[type="number"], button[onclick^="submitScore"]').forEach(el => {
                    if (isAdminLoggedIn) {
                        el.disabled = false;
                        el.classList.remove('opacity-50', 'cursor-not-allowed');
                    } else {
                        el.disabled = true;
                        el.classList.add('opacity-50', 'cursor-not-allowed');
                    }
                });
            }
            
            // Update UI Tab setelah konten di-render
            updateTabUI(currentView);
        };

        // Mulai aplikasi
        window.onload = () => {
            setActiveTab('schedule'); // Set initial view and call initFirebase
            initFirebaseAndAuth();
        };

    </script>

    <!-- UI/UX Aplikasi -->
    <div class="min-h-screen">
        <!-- Header -->
        <header class="header-bg py-4 mb-8">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center">
                <h1 class="text-3xl font-extrabold text-white tracking-tight">
                    <span class="text-yellow-300">Liga EFootball</span>
                </h1>
                <div class="flex items-center space-x-3">
                    <div id="connection-status" class="p-2 rounded-lg text-sm font-medium bg-yellow-100 text-yellow-700 transition-colors duration-300">
                        Menunggu koneksi...
                    </div>
                    
                    <!-- Tombol Admin BARU (Memanggil Modal) -->
                    <button onclick="showAdminModal()" class="bg-yellow-500 text-white font-semibold py-2 px-3 rounded-lg shadow-md hover:bg-yellow-600 transition-colors">
                        Admin
                    </button>
                    <!-- Tombol Admin LAMA Dihapus -->

                </div>
            </div>
        </header>

        <!-- Tab Navigation (NEW) -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mb-4">
            <div class="flex border-b border-gray-300 rounded-t-lg overflow-hidden shadow-md">
                <button id="tab-schedule" onclick="setActiveTab('schedule')" class="flex-1 py-3 px-6 text-center text-base font-semibold border-b-4 border-blue-600 bg-gray-50 transition-colors duration-200 text-gray-700">
                    Jadwal & Skor
                </button>
                <button id="tab-standings" onclick="setActiveTab('standings')" class="flex-1 py-3 px-6 text-center text-base font-semibold border-b-4 border-transparent bg-white hover:border-blue-300 transition-colors duration-200 text-gray-700">
                    Klasemen
                </button>
            </div>
        </div>

        <!-- Konten Utama -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-12">
            <div id="app-container" class="space-y-8">
                <!-- Konten akan dirender oleh JavaScript -->
                <div class="card p-8 text-center text-gray-500">
                    <svg class="animate-spin h-8 w-8 text-blue-500 mx-auto mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Memuat data dan menghubungkan ke Cloud Database...
                </div>
            </div>
        </main>
    </div>

    <!-- Admin Login MODAL (Popup) -->
    <div id="admin-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Akses Admin</h2>
            <p class="text-gray-600 mb-6">Masukkan kata sandi admin untuk melanjutkan.</p>
            <input type="password" id="admin-password-input" 
                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500 mb-4" 
                   placeholder="Kata Sandi">
            <p id="admin-login-message" class="text-red-500 text-sm mb-4"></p>
            <div class="flex space-x-3">
                <button onclick="authenticateAdmin()" class="flex-grow bg-red-600 text-white p-3 rounded-lg font-semibold hover:bg-red-700 transition duration-200">
                    Masuk
                </button>
                <button onclick="hideAdminModal()" class="bg-gray-300 text-gray-800 p-3 rounded-lg font-semibold hover:bg-gray-400 transition duration-200">
                    Batal
                </button>
            </div>
        </div>
    </div>
    <!-- END Admin Login MODAL -->

</body>
</html>
